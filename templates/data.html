{% extends "base.html" %}

{% block content %}
<style>
    .table-container {
        margin-top: 20px;
        background-color: #ffffff;
        padding: 0;
        border: 1px solid #808080;
        overflow-x: auto;
        width: fit-content;
        max-width: calc(100% - 170px);
    }
    
    .header-row, .data-row {
        display: flex;
        margin: 0;
        border-bottom: 1px solid #808080;
        height: 30px;
        width: 100%;
    }

    .header-row {
        background-color: #f0f0f0;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .header-row > span, 
    .data-row > span {
        border-right: 1px solid #808080;
        padding: 4px;
        font-family: monospace;
        overflow: hidden;
        white-space: nowrap;
        box-sizing: border-box;
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .header-row > span:last-child,
    .data-row > span:last-child {
        flex: 0 0 80px;
    }
    
    .header-item {
        color: #000000;
        font-weight: bold;
        width: 100%;
        text-align: center;
    }
    
    .cell {
        color: #000000;
        text-align: center;
    }

    .empty-cell {
        background-color: #ffffff;
        width: 100%;
    }

    .table-wrapper {
        position: relative;
        max-height: 1000px;
        overflow: auto;
    }

    /* Стили для области загрузки файла */
    .upload-container {
        margin-bottom: 20px;
    }

    .title {
        color: #000000;
    }

    .error-message {
        color: red;
        margin: 10px 0;
        text-align: center;
    }

    .success-message {
        color: green;
        margin: 10px 0;
        text-align: center;
    }

    .drop-zone {
        width: 100%;
        max-width: 400px;
        height: 200px;
        padding: 25px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-weight: 500;
        font-size: 16px;
        cursor: pointer;
        color: #000000;
        border: 4px dashed #cccccc;
        border-radius: 10px;
        margin: 20px auto;
        position: relative;
    }

    .drop-zone--over {
        border-color: #000;
        background-color: rgba(0, 0, 0, 0.05);
    }

    .drop-zone__input {
        display: none;
    }

    .drop-zone__button {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #f0f0f0;
        border: 1px solid #808080;
        cursor: pointer;
        color: #000000;
    }

    .drop-zone__button:hover {
        background-color: #e0e0e0;
    }

    .unique-ids-container {
        margin: 20px 0;
        padding: 10px;
        background-color: #ffffff;
        border: 1px solid #808080;
    }

    .unique-ids-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .unique-id {
        padding: 5px 10px;
        background-color: #f0f0f0;
        border: 1px solid #808080;
        border-radius: 3px;
        font-family: monospace;
        color: #000000;
    }

    .workspace {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        width: 100%;
    }

    .id-selector {
        flex: 0 0 150px;
        background-color: #ffffff;
        border: 1px solid #808080;
        padding: 10px;
        height: fit-content;
    }

    .id-selector h2 {
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: bold;
        color: #000000;
    }

    .id-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
        max-height: 400px;
        overflow-y: auto;
    }

    .id-checkbox-label {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 3px;
        font-family: monospace;
        color: #000000 !important;
    }

    .id-checkbox-label:hover {
        background-color: #f0f0f0;
    }

    .control-buttons {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin: 10px 0;
    }

    .control-button {
        padding: 5px 10px;
        background-color: #f0f0f0;
        border: 1px solid #808080;
        cursor: pointer;
        color: #000000;
        width: 100%;
        text-align: center;
    }

    .control-button:hover {
        background-color: #e0e0e0;
    }

    .id-checkbox {
        margin-right: 5px;
    }

    .id-selector, 
    .id-selector * {
        color: #000000;
    }

    .main-content {
        flex: 1;
        min-width: 0;
    }

    /* Базовые классы для разной ширины ячеек */
    .cell-id {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
    }
    
    .cell-data {
        width: 45px;
        min-width: 45px;
        max-width: 45px;
    }
    
    .cell-time {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
    }
</style>

<div class="upload-container">
    <h1 class="title" style="color: #000000;">LIN - Загрузка CSV файла</h1>
    
    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}
    
    {% if filename %}
        <div class="success-message">Загружен файл: {{ filename }}</div>
    {% endif %}

    <form id="upload-form" action="{{ url_for('data') }}" method="POST" enctype="multipart/form-data">
        <div class="drop-zone">
            <span class="drop-zone__prompt">Перетащите CSV файл сюда или нажмите для выбора</span>
            <button type="button" class="drop-zone__button">Выбрать файл</button>
            <input type="file" name="file" class="drop-zone__input" accept=".csv">
        </div>
    </form>
</div>

{% if messages %}
    {% if unique_ids %}
        <div class="workspace">
            <div class="id-selector">
                <h2>Выбор ID</h2>
                <div class="control-buttons">
                    <button class="control-button" id="select-all">Выбрать все</button>
                    <button class="control-button" id="clear-all">Снять выбор</button>
                </div>
                <div class="id-list">
                    {% for id in unique_ids %}
                        <label class="id-checkbox-label">
                            <input type="checkbox" class="id-checkbox" value="{{ id }}" checked>
                            {{ "%02X"|format(id) }}
                        </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="main-content">
                <div class="table-container">
                    <div class="table-wrapper">
                        <div class="header-row">
                            <span class="cell-id"><span class="header-item">ID</span></span>
                            {% for i in range(messages[0].data|length + 1) %}
                                <span class="cell-data"><span class="header-item">D{{ i + 1 }}</span></span>
                            {% endfor %}
                            <span class="cell-time"><span class="header-item">Time</span></span>
                        </div>
                        {% for msg in messages %}
                            <div class="data-row" data-id="{{ msg.id }}">
                                <span class="cell-id cell">
                                    {% if msg.id is not none %}
                                        {{ "%02X"|format(msg.id) }}
                                    {% else %}
                                        <span class="empty-cell">&nbsp;</span>
                                    {% endif %}
                                </span>
                                {% for value in msg.data %}
                                    <span class="cell-data cell">
                                        {% if value is not none %}
                                            {{ "%02X"|format(value) }}
                                        {% else %}
                                            <span class="empty-cell">&nbsp;</span>
                                        {% endif %}
                                    </span>
                                {% endfor %}
                                <span class="cell-data cell">
                                    {% if msg.crc is not none %}
                                        {{ "%02X"|format(msg.crc) }}
                                    {% else %}
                                        <span class="empty-cell">&nbsp;</span>
                                    {% endif %}
                                </span>
                                <span class="cell-time cell">{{ "%.3f"|format(msg.time) }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll(".drop-zone").forEach(dropZone => {
        const input = dropZone.querySelector(".drop-zone__input");
        const button = dropZone.querySelector(".drop-zone__button");
        const prompt = dropZone.querySelector(".drop-zone__prompt");
        const form = dropZone.closest('form');

        // Клик по зоне загрузки
        dropZone.addEventListener("click", (e) => {
            if (e.target !== button) {
                input.click();
            }
        });

        // Клик по кнопке
        button.addEventListener("click", () => {
            input.click();
        });

        input.addEventListener("change", (e) => {
            if (input.files.length) {
                form.submit();
            }
        });

        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("drop-zone--over");
        });

        ["dragleave", "dragend"].forEach((type) => {
            dropZone.addEventListener(type, (e) => {
                dropZone.classList.remove("drop-zone--over");
            });
        });

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();

            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                form.submit();
            }

            dropZone.classList.remove("drop-zone--over");
        });
    });

    const checkboxes = document.querySelectorAll('.id-checkbox');
    const selectAllBtn = document.getElementById('select-all');
    const clearAllBtn = document.getElementById('clear-all');
    const rows = document.querySelectorAll('.data-row');

    function updateTableVisibility() {
        const selectedIds = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => parseInt(cb.value));

        rows.forEach(row => {
            const rowId = parseInt(row.dataset.id);
            row.style.display = selectedIds.includes(rowId) ? '' : 'none';
        });
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTableVisibility);
    });

    selectAllBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = true);
        updateTableVisibility();
    });

    clearAllBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = false);
        updateTableVisibility();
    });

    function adjustTableWidth() {
        const tableContainer = document.querySelector('.table-container');
        const table = document.querySelector('.table-wrapper');
        if (!tableContainer || !table) return;

        // Получаем количество столбцов из первой строки
        const headerRow = table.querySelector('.header-row');
        if (!headerRow) return;

        // Вычисляем общую минимальную ширину таблицы
        const idWidth = 50;  // ширина столбца ID
        const dataWidth = 45;  // ширина столбцов данных
        const timeWidth = 80;  // ширина столбца времени
        const dataColumns = headerRow.children.length - 2;  // общее количество столбцов минус ID и Time
        
        const minTableWidth = idWidth + (dataColumns * dataWidth) + timeWidth;
        
        // Устанавливаем минимальную ширину таблицы
        table.style.minWidth = `${minTableWidth}px`;
    }

    // Вызываем функцию при загрузке и при изменении размера окна
    adjustTableWidth();
    window.addEventListener('resize', adjustTableWidth);
});
</script>
{% endblock %} 